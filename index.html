<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gustav does the N-Back</title>
  <style>
    /* --- CSS STYLES --- */
    body {
      font-family: system-ui, sans-serif;
      background: #050505;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh; /* changed from height to min-height for safety */
      margin: 0;
      padding: 10px;
      overflow-x: hidden; /* Prevent horizontal scroll */
      user-select: none;
      -webkit-tap-highlight-color: transparent; /* Remove blue tap box on mobile */
    }

    h1 {
      margin: 0.5rem 0;
      text-align: center;
      color: #60a5fa;
      font-size: 1.5rem;
      letter-spacing: 1px;
    }

    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      max-width: 600px; /* Slightly narrower max-width for better vertical stacking */
      width: 100%;
    }

    /* --- STATS BAR --- */
    #status-bar {
      display: flex;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: bold;
      flex-wrap: wrap;
      width: 100%;
    }

    .status-pill {
      padding: 6px 10px;
      border-radius: 8px;
      background: #111;
      border: 1px solid #222;
      flex: 1 1 auto; /* Grow to fill space on mobile */
      min-width: 60px;
      text-align: center;
      white-space: nowrap;
    }

    .text-orange { color: #fb923c; }
    .text-blue   { color: #60a5fa; }
    .text-white  { color: #e5e7eb; }

    /* --- SETTINGS PANEL --- */
    #settings-container {
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 12px;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .settings-row {
      display: flex;
      justify-content: center;
      align-items: flex-end; 
      flex-wrap: wrap;
      gap: 10px;
    }

    .setting-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .setting-group label { margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }

    input[type="number"], input[type="text"], select {
      background: #18181b;
      color: #60a5fa;
      border: 1px solid #333;
      padding: 8px; /* Larger touch target */
      border-radius: 6px;
      text-align: center;
      font-weight: bold;
      font-size: 1rem; /* readable font size prevents auto-zoom on iOS */
      outline: none;
      cursor: pointer;
    }
    
    input[type="text"] { width: 100%; max-width: 180px; text-transform: uppercase; }
    input[type="number"] { width: 60px; }
    select { min-width: 80px; }
    input[type="range"] { width: 100%; max-width: 200px; accent-color: #60a5fa; cursor: pointer; height: 20px; }

    .val-display {
      font-size: 0.75rem;
      color: #60a5fa;
      font-weight: bold;
      margin-top: 2px;
    }

    /* --- RESPONSIVE GRID --- */
    #grid {
      display: grid;
      gap: 8px;
      margin-top: 10px;
      position: relative;
      /* FIX 2: Dynamic Sizing */
      width: 100%;          /* Fill container width */
      max-width: 380px;     /* Don't get too huge on desktop */
      aspect-ratio: 1 / 1;  /* Force it to be a square */
    }

    .cell {
      border-radius: 12px;
      border: 2px solid #222; 
      background: #0f0f0f;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.1s;
      width: 100%;  /* Fill the grid track */
      height: 100%; /* Fill the grid track */
    }

    .cell.active {
      background: #fb923c; 
      box-shadow: 0 0 25px rgba(251, 146, 60, 0.4);
      border-color: #fdba74;
    }

    /* --- FLASH CONTROL --- */
    #flash-control {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 5px;
        width: 100%;
    }
    #flash-control label { font-size: 0.7rem; color: #555; margin-bottom: 2px; }

    /* --- MOBILE MATCH BUTTON --- */
    #mobile-match-area {
        width: 100%;
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }
    #match-btn {
        background: #fb923c; 
        color: #000;
        width: 100%;
        max-width: 280px; /* Nice wide button on mobile */
        height: 60px;
        font-size: 1.4rem;
        font-weight: 900;
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px #c2410c;
        transition: transform 0.1s, box-shadow 0.1s;
        cursor: pointer;
        -webkit-user-select: none; /* prevent long-press text selection */
    }
    #match-btn:active {
        transform: translateY(4px);
        box-shadow: 0 0 #c2410c;
        background: #fff;
    }
    #match-btn:disabled {
        background: #333;
        box-shadow: none;
        color: #555;
        cursor: not-allowed;
    }

    /* --- CONTROLS --- */
    #controls {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }

    button.ctrl-btn {
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 700;
      transition: transform 0.1s;
    }

    #start-btn { background: #3b82f6; color: #fff; } 
    #start-btn:hover { transform: scale(1.05); }

    #stop-btn { background: #333; color: #aaa; } 
    #stop-btn:enabled:hover { background: #444; color: #fff; }

    /* --- RESULTS & INSTRUCTIONS --- */
    #last-result {
      margin-top: 5px;
      font-size: 1rem;
      font-weight: bold;
      color: #555;
      min-height: 1.2rem;
      text-align: center;
    }

    #instructions {
      margin-top: 10px;
      margin-bottom: 20px;
      color: #555;
      font-size: 0.8rem;
      text-align: center;
      line-height: 1.4;
    }

    /* --- GUSTAV THE GOOSE --- */
    #gustav-wrapper {
        margin-top: 30px; 
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }
    
    #gustav-img {
        width: 140px; /* Reduced slightly so it fits better on small screens */
        height: auto;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: help; 
    }

    #gustav-img:hover { transform: rotate(-10deg) scale(1.1); }
    #gustav-img.shake { animation: shake 0.4s ease-in-out; }
    #gustav-img.bounce { animation: bounce 0.4s ease-in-out; }

    .honk-text {
        font-size: 1.2rem;
        font-weight: 900;
        margin-bottom: 5px;
        opacity: 0;
        transition: opacity 0.2s, transform 0.2s;
        position: absolute;
        top: -30px; 
        white-space: nowrap;
        pointer-events: none;
    }
    
    #gustav-wrapper:hover .honk-text { opacity: 1; transform: translateY(-5px); }
    .honk-text.show { opacity: 1; transform: translateY(-10px); }
    .honk-text.bad { color: #fb923c; } 
    .honk-text.good { color: #60a5fa; } 

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px) rotate(-10deg); }
      75% { transform: translateX(5px) rotate(10deg); }
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px) scale(1.1); }
    }

  </style>
</head>
<body>

  <div id="game-container">
    <h1>Gustav-N-BackÔ∏è</h1>

    <div id="settings-container">
      <div class="settings-row">
        <div class="setting-group">
          <label>N-Back</label>
          <input type="number" id="n-setting" value="2" min="1" max="5">
        </div>
        
        <div class="setting-group">
          <label>Cycle Time</label>
          <select id="speed-select">
            <option value="0.5">0.5 s (Turbo)</option>
            <option value="1.0">1.0 s (Fast)</option>
            <option value="1.5" selected>1.5 s</option>
            <option value="2.0">2.0 s</option>
            <option value="2.5">2.5 s (Normal)</option>
          </select>
        </div>
        
        <div class="setting-group">
          <label>Trials</label>
          <input type="number" id="trials-setting" value="75" min="5" max="1000" step="5">
        </div>
      </div>

      <div class="settings-row">
        <div class="setting-group">
            <label>Grid Size</label>
            <input type="number" id="grid-size-setting" value="3" min="3" max="5">
        </div>

        <div class="setting-group">
          <label>Letters</label>
          <input type="text" id="letters-setting" value="K, L, R, Q, Z, W, H, O, Y">
        </div>
      </div>

      <hr style="width:100%; border:0; border-top:1px solid #222; margin: 0;">

      <div class="settings-row">
         <div class="setting-group">
           <label>Voice</label>
           <select id="voice-select">
             <option value="">Loading...</option>
           </select>
        </div>
      </div>
    </div>

    <div id="status-bar">
      <div class="status-pill text-blue">Correct: <span id="score-correct">0</span></div>
      <div class="status-pill text-orange">Wrong: <span id="score-wrong">0</span></div>
      <div class="status-pill" style="color:#e5e7eb">Trial: <span id="trial-count">0</span> / <span id="max-trials-display">75</span></div>
    </div>

    <div id="grid"></div>
    
    <div id="flash-control">
        <label>Flash Time</label>
        <input type="range" id="flash-duration" min="20" max="1500" step="10" value="800">
        <span class="val-display" id="val-flash">800 ms</span>
    </div>

    <div id="gustav-wrapper">
        <div class="honk-text" id="gustav-msg">Honk!</div>
        <img src="gustav.png" id="gustav-img" alt="Gustav ü™ø" title="Honk?">
    </div>

    <div id="mobile-match-area">
        <button id="match-btn" disabled>MATCH!</button>
    </div>

    <div id="controls">
      <button id="start-btn" class="ctrl-btn">Start Game</button>
      <button id="stop-btn" class="ctrl-btn" disabled>Stop</button>
    </div>

    <div id="last-result"></div>

    <div id="instructions">
      <strong>SPACEBAR</strong> = Match.<br>
      Voice speed is automatically optimized.
    </div>

  </div>

  <script>
    /* ====== CONFIG ====== */
    let activeLetters = []; 
    let nValue = 2; 
    let cycleTimeMs = 1500; 
    let flashDurationMs = 800;
    let maxTrials = 75; 
    let gridSize = 3;
    let calculatedVoiceRate = 1.0; 

    let voices = [];
    const synth = window.speechSynthesis;

    /* ====== DOM ELEMENTS ====== */
    const gridEl = document.getElementById('grid');
    const scoreCorrectEl = document.getElementById('score-correct');
    const scoreWrongEl = document.getElementById('score-wrong');
    const trialCountEl = document.getElementById('trial-count');
    const maxTrialsEl = document.getElementById('max-trials-display');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const lastResultEl = document.getElementById('last-result');
    const matchBtn = document.getElementById('match-btn'); 
    
    const flashDurInput = document.getElementById('flash-duration');
    const valFlash = document.getElementById('val-flash');

    const nInput = document.getElementById('n-setting');
    const speedSelect = document.getElementById('speed-select');
    const trialsInput = document.getElementById('trials-setting');
    const gridInput = document.getElementById('grid-size-setting'); 
    const lettersInput = document.getElementById('letters-setting');
    const voiceSelect = document.getElementById('voice-select');
    
    const gustavImg = document.getElementById('gustav-img');
    const gustavMsg = document.getElementById('gustav-msg');

    /* ====== VOICE LOADER (NO GOOGLE) ====== */
    function populateVoiceList() {
      voices = synth.getVoices().sort((a, b) => {
          const aname = a.name.toUpperCase();
          const bname = b.name.toUpperCase();
          if (aname < bname) return -1;
          if (aname > bname) return 1;
          return 0;
      });
      
      const filteredVoices = voices.filter(v => 
          v.lang.startsWith('en') && !v.name.includes('Google')
      );
      
      voiceSelect.innerHTML = '';
      const displayVoices = filteredVoices.length > 0 ? filteredVoices : voices; 

      displayVoices.forEach((voice) => {
        const option = document.createElement('option');
        option.textContent = `${voice.name} (${voice.lang})`;
        option.setAttribute('data-name', voice.name);
        voiceSelect.appendChild(option);
      });
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = populateVoiceList;
    }
    populateVoiceList();

    /* ====== UI HANDLERS ====== */
    trialsInput.oninput = () => maxTrialsEl.textContent = trialsInput.value;
    flashDurInput.oninput = () => valFlash.textContent = flashDurInput.value + " ms";

    /* ====== STATE ====== */
    let isRunning = false;
    let trialIndex = 0;
    let timerId = null;
    let blankTimerId = null;
    const history = [];
    let currentStimulus = null;
    let userResponded = false;
    let scoreCorrect = 0;
    let scoreWrong = 0;
    let cells = [];

    /* ====== GUSTAV FEEDBACK ====== */
    let msgTimer = null;
    function showGustav(text, type) {
        clearTimeout(msgTimer);
        gustavMsg.classList.remove('show', 'bad', 'good');
        gustavImg.classList.remove('shake', 'bounce');
        void gustavImg.offsetWidth; 

        gustavMsg.textContent = text;
        
        if (type === 'bad') {
            gustavMsg.classList.add('bad');
            gustavImg.classList.add('shake');
        } else {
            gustavMsg.classList.add('good');
            gustavImg.classList.add('bounce');
        }

        gustavMsg.classList.add('show');
        msgTimer = setTimeout(() => {
            gustavMsg.classList.remove('show');
        }, 1000);
    }

    /* ====== GRID BUILDER (UPDATED FOR CSS RESPONSIVENESS) ====== */
    function buildGrid(size) {
      gridEl.innerHTML = ''; 
      cells = [];
      
      // FIX 3: Use Fractional Units (1fr) so CSS handles sizing
      gridEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
      gridEl.style.gridTemplateRows = `repeat(${size}, 1fr)`;
      
      const totalCells = size * size;

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        // Note: No fixed width/height set here anymore
        gridEl.appendChild(cell);
        cells.push(cell);
      }
    }
    buildGrid(3);

    /* ====== FUNCTIONS ====== */
    function clearGrid() {
      cells.forEach(c => {
        c.classList.remove('active');
        c.style.backgroundColor = ""; 
        c.style.borderColor = ""; 
        c.style.boxShadow = "";
      });
    }

    function updateScoreUI() {
      scoreCorrectEl.textContent = scoreCorrect;
      scoreWrongEl.textContent = scoreWrong;
    }

    function speakLetter(text) {
      if (synth.speaking) synth.cancel();
      
      const utterThis = new SpeechSynthesisUtterance(text);
      utterThis.rate = calculatedVoiceRate;
      utterThis.pitch = 1.0;
      utterThis.volume = 1.0; 

      const selectedOption = voiceSelect.selectedOptions[0];
      if(selectedOption) {
        const selectedName = selectedOption.getAttribute('data-name');
        const foundVoice = voices.find(v => v.name === selectedName);
        if (foundVoice) utterThis.voice = foundVoice;
      }

      synth.speak(utterThis);
    }

    function getLetterPool() {
        const raw = lettersInput.value;
        let pool = raw.split(/[ ,|]+/).map(s => s.trim().toUpperCase()).filter(s => s.length > 0);
        pool = [...new Set(pool)];
        if (pool.length < 2) return ['A', 'B'];
        return pool;
    }

    function getAutoRate(cycleS) {
        if (cycleS <= 0.5) return 3.0; 
        if (cycleS <= 1.0) return 2.5;
        if (cycleS <= 1.5) return 2.0;
        if (cycleS <= 2.0) return 1.5;
        return 1.2; 
    }

    /* ====== GAME LOGIC ====== */
    function startSession() {
      if (isRunning) return;

      nValue = parseInt(nInput.value);
      let cycleS = parseFloat(speedSelect.value);
      cycleTimeMs = cycleS * 1000;
      calculatedVoiceRate = getAutoRate(cycleS);

      maxTrials = parseInt(trialsInput.value); 
      flashDurationMs = parseInt(flashDurInput.value);
      gridSize = parseInt(gridInput.value); 

      const maxAllowedFlash = cycleTimeMs * 0.6;
      if (flashDurationMs > maxAllowedFlash) {
         flashDurationMs = maxAllowedFlash;
         if (flashDurationMs < 50) flashDurationMs = 50;
      }
      
      activeLetters = getLetterPool();
      buildGrid(gridSize);
      toggleInputs(true);
      lastResultEl.innerHTML = ''; 
      maxTrialsEl.textContent = maxTrials;

      isRunning = true;
      trialIndex = 0;
      history.length = 0;
      scoreCorrect = 0;
      scoreWrong = 0;
      updateScoreUI();

      runNextTrial();
    }

    function stopSession(completed = false) {
      isRunning = false;
      clearTimeout(timerId);
      clearTimeout(blankTimerId);
      clearGrid();
      synth.cancel();
      toggleInputs(false);
      
      const statusText = completed ? "Finished!" : "Stopped";
      lastResultEl.innerHTML = `
        <div style="font-size:1.2rem; color:#fff; margin-bottom:5px;">${statusText}</div>
        <div style="display:flex; gap:15px; justify-content:center;">
           <span class="text-blue">C: ${scoreCorrect}</span>
           <span class="text-orange">W: ${scoreWrong}</span>
           <span class="text-white">T: ${trialIndex}</span>
        </div>
      `;
    }

    function toggleInputs(disabled) {
      startBtn.disabled = disabled;
      stopBtn.disabled = !disabled;
      nInput.disabled = disabled;
      speedSelect.disabled = disabled;
      trialsInput.disabled = disabled;
      gridInput.disabled = disabled;
      lettersInput.disabled = disabled;
      flashDurInput.disabled = disabled;
      voiceSelect.disabled = disabled;
      matchBtn.disabled = !disabled;
    }

    function checkMatch() {
        if (!isRunning || userResponded) return;
        userResponded = true;

        if (currentStimulus.isMatch) {
          scoreCorrect++;
          showGustav("Good Job!", "good");
        } else {
          scoreWrong++;
          showGustav("HONK!", "bad");
        }
        updateScoreUI();
    }

    function runNextTrial() {
      if (!isRunning) return;

      if (trialIndex >= maxTrials) {
        stopSession(true);
        return;
      }

      trialIndex++;
      trialCountEl.textContent = trialIndex;
      userResponded = false;

      const totalCells = gridSize * gridSize;
      const posIndex = Math.floor(Math.random() * totalCells);
      const letter = activeLetters[Math.floor(Math.random() * activeLetters.length)];
      currentStimulus = { posIndex, letter };

      let matchExists = false;
      if (history.length >= nValue) {
        const pastItem = history[history.length - nValue];
        if (pastItem.posIndex === posIndex || pastItem.letter === letter) {
          matchExists = true;
        }
      }
      currentStimulus.isMatch = matchExists;

      const activeCell = cells[posIndex];
      activeCell.classList.add('active');
      activeCell.style.backgroundColor = `rgba(251, 146, 60, 1)`; 
      activeCell.style.borderColor = `rgba(253, 186, 116, 1)`; 
      activeCell.style.boxShadow = `0 0 20px rgba(251, 146, 60, 0.6)`;

      speakLetter(letter);

      timerId = setTimeout(() => {
        clearGrid(); 
        blankTimerId = setTimeout(() => {
          if (currentStimulus.isMatch && !userResponded) {
            scoreWrong++;
            // MISS -> Gustav Honks
            showGustav("HONK!", "bad");
            updateScoreUI();
          }
          history.push({ posIndex, letter });
          runNextTrial();
        }, (cycleTimeMs - flashDurationMs));

      }, flashDurationMs);
    }

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        checkMatch();
      }
    });

    matchBtn.addEventListener('click', (e) => {
        e.preventDefault(); 
        checkMatch();
    });

    matchBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        checkMatch();
    });

    startBtn.addEventListener('click', startSession);
    stopBtn.addEventListener('click', () => stopSession(false));

  </script>
</body>
</html>